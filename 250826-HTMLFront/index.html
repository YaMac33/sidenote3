<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>25.8.26 フロントエンド実装マニュアル</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better readability and aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        
        h1, h2, h3 {
            font-weight: 700;
        }

        .code-block-container {
            position: relative;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .copy-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            background-color: #4a5568; /* gray-700 */
            color: white;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid #2d3748; /* gray-800 */
        }

        .copy-button:hover {
            background-color: #2d3748; /* gray-800 */
        }
        
        .copy-button.copied {
            background-color: #2f855a; /* green-700 */
        }

        pre {
            background-color: #1a202c; /* gray-900 */
            color: #e2e8f0; /* slate-200 */
            padding: 1.5rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        code {
            font-family: 'Menlo', 'Monaco', 'Consolas', "Courier New", monospace;
        }
        
        hr {
            border-color: #e2e8f0; /* slate-200 */
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">25.8.26 フロントエンド実装マニュアル</h1>
        </header>

        <main class="bg-white p-6 sm:p-8 rounded-lg shadow-md">

            <h2 class="text-2xl font-semibold border-b pb-2 mb-4">HTML</h2>
            <hr>

            <!-- Section 1: Copy All Content -->
            <section>
                <h3 class="text-xl font-semibold mt-6 mb-2">1. 回答全体をワンタッチコピー可能にする</h3>
                <ul class="list-disc list-inside space-y-2 text-gray-700">
                    <li>メッセージエリア (<code>#chat</code>) に回答メッセージをレンダリングするときに、コピー用ボタンを付加する HTML を生成します。</li>
                    <li><code>script.js</code> 側でクリックイベントを拾い、クリップボードにコピーします。</li>
                </ul>
                <div class="code-block-container">
                    <button class="copy-button" onclick="copyCode(this)">Copy</button>
<pre><code class="language-html">
&lt;div class="assistant-msg"&gt;
  &lt;button class="copy-all-btn" title="回答全体をコピー"&gt;📋&lt;/button&gt;
  &lt;div class="msg-content"&gt;ここにAIの回答が入る&lt;/div&gt;
&lt;/div&gt;
</code></pre>
                </div>
            </section>
            
            <hr>

            <!-- Section 2: Copy Code Blocks -->
            <section>
                <h3 class="text-xl font-semibold mt-6 mb-2">2. コードブロックだけ個別コピー可能にする</h3>
                <ul class="list-disc list-inside space-y-2 text-gray-700">
                    <li>AIの出力にコードが含まれる場合、<code>&lt;pre&gt;&lt;code&gt;...&lt;/code&gt;&lt;/pre&gt;</code> 形式に変換。</li>
                    <li>コードブロックの横にコピーアイコンを追加します。</li>
                    <li>JinjaテンプレートやJS側で出力する際に <code>{{ content | e }}</code> または <code>html.escape()</code> を使い、HTMLタグを無効化して実際のコードとして見せるのがポイントです。</li>
                </ul>
                <p class="mt-4 text-gray-700">例：</p>
                <div class="code-block-container">
                    <button class="copy-button" onclick="copyCode(this)">Copy</button>
<pre><code class="language-html">
&lt;div class="code-block"&gt;
  &lt;button class="copy-code-btn" title="コードをコピー"&gt;📋&lt;/button&gt;
  &lt;pre&gt;&lt;code&gt;print("Hello World")&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
</code></pre>
                </div>
            </section>

            <hr>

            <!-- Section 3: JS Calls -->
            <section>
                <h3 class="text-xl font-semibold mt-6 mb-2">3. ルーム名称変更・削除のJS呼び出し</h3>
                <p class="text-gray-700">HTML側はすでにモーダルが用意されているので、script.jsで以下の動作を実装します。</p>
                <ul class="list-disc list-inside space-y-2 mt-2 text-gray-700">
                    <li>右クリック or 3点メニュークリック → context-menu表示</li>
                    <li><code>rename-room</code> → <code>PATCH /rooms/:id</code> 呼び出し</li>
                    <li><code>delete-room</code> → <code>DELETE /rooms/:id</code> 呼び出し</li>
                    <li>成功後、<code>#rooms</code> を再取得（<code>fetch("/rooms")</code>）してリストを更新</li>
                </ul>
            </section>

            <hr>

            <!-- Section 4: Escaping -->
            <section>
                <h3 class="text-xl font-semibold mt-6 mb-2">4. エスケープ処理を必ずサーバー側で行う</h3>
                <ul class="list-disc list-inside space-y-2 text-gray-700">
                    <li>現状の出力方法だと、AIが出した <strong>**太字**</strong> や <code>&lt;b&gt;</code> タグがそのままレンダリングされてしまいます。</li>
                    <li>サーバー側で <code>html.escape()</code> を使うか、Jinjaで <code>{{ content | e }}</code> を使用してエスケープしてください。</li>
                    <li>その後にフロントで <code>markdown-it</code> 等を使う場合のみ、コードブロック以外をMarkdown変換します。</li>
                </ul>
            </section>

            <hr>

            <!-- Section 5: Timestamp -->
            <section>
                <h3 class="text-xl font-semibold mt-6 mb-2">5. タイムスタンプを日本時間にする</h3>
                <p class="text-gray-700"><code>app.py</code> 側は前メッセージの修正版でOKです（<code>ZoneInfo("Asia/Tokyo")</code>を使用）。</p>
            </section>

            <hr>
            
            <!-- Section 6: Next Steps -->
            <section>
                <h2 class="text-2xl font-semibold border-b pb-2 mb-4">次のステップ</h2>
                <h3 class="text-lg font-semibold mt-4">A. script.js を全面的に修正します</h3>
                <ul class="list-disc list-inside space-y-2 mt-2 text-gray-700">
                    <li>ルーム右クリック → サブメニュー表示 → 名称変更 / 削除API呼び出し</li>
                    <li>メッセージレンダリング時に「全体コピー」と「コードブロックコピー」機能を実装</li>
                    <li>エスケープ済みのテキストをHTMLに組み込む</li>
                </ul>
                <h3 class="text-lg font-semibold mt-4">B. style.css にコピーアイコンなどのUIを追加</h3>
            </section>

            <hr>

            <!-- Section 7: Question -->
            <section>
                <h2 class="text-2xl font-semibold border-b pb-2 mb-4">質問</h2>
                <blockquote class="border-l-4 border-slate-300 pl-4 py-2 my-4 bg-slate-50 text-gray-700">
                    <p>static/script.js の現行コードも送れますか？</p>
                    <ul class="list-disc list-inside space-y-1 mt-2">
                        <li>どのようにメッセージを描画しているか確認したいです。</li>
                        <li>それによって「全体コピー」「コード個別コピー」の実装を具体的なコードとして提示できます。</li>
                    </ul>
                    <p class="mt-2">送っていただければ、修正版の app.py + script.js + 必要なHTML補足 + CSS改善案をフルコードで返します。</p>
                </blockquote>
            </section>
        </main>
    </div>

    <script>
        function copyCode(button) {
            // Find the <pre><code> element associated with the button
            const codeBlockContainer = button.parentElement;
            const codeElement = codeBlockContainer.querySelector('code');
            
            if (codeElement) {
                // Create a temporary textarea element to hold the text
                const textArea = document.createElement('textarea');
                textArea.value = codeElement.innerText;
                
                // Make it invisible and append it to the body
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                
                // Select and copy the text
                textArea.select();
                try {
                    document.execCommand('copy');
                    // Provide feedback to the user
                    button.textContent = 'Copied!';
                    button.classList.add('copied');
                    
                    // Reset the button text after a short delay
                    setTimeout(() => {
                        button.textContent = 'Copy';
                        button.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    button.textContent = 'Error';
                }
                
                // Clean up the temporary element
                document.body.removeChild(textArea);
            }
        }
    </script>

</body>
</html>
