<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notioné€£æºAIãƒãƒ£ãƒƒãƒˆæ”¹é€ æ‰‹é †</title>
    <style>
        body {
            font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            line-height: 1.6;
            margin: 2rem;
            background-color: #f9f9f9;
            color: #333;
        }
        h1, h2, h3, h4 {
            margin-top: 2rem;
            color: #222;
        }
        pre {
            background: #272822;
            color: #f8f8f2;
            padding: 1rem;
            overflow-x: auto;
            border-radius: 6px;
        }
        code {
            background: #eee;
            padding: 0.2em 0.4em;
            border-radius: 4px;
        }
        hr {
            margin: 2rem 0;
        }
        .note {
            background: #fff8c4;
            border-left: 4px solid #ffd42a;
            padding: 1rem;
            margin: 1rem 0;
        }
        ul, ol {
            margin-left: 1.5rem;
        }
    </style>
</head>
<body>
    <h1>Notioné€£æºAIãƒãƒ£ãƒƒãƒˆï¼šã‚¢ãƒ—ãƒªæ”¹é€ æ‰‹é †</h1>
    <p>ã¯ã„ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ã“ã‚Œã¯éå¸¸ã«é¢ç™½ã„æ©Ÿèƒ½è¿½åŠ ã§ã™ã­ï¼Renderã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å‰ã«ã€ã‚¢ãƒ—ãƒªã‚’ã•ã‚‰ã«è³¢ãã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>
    <p>AIã«è³ªå•ã™ã‚‹å‰ã«ã€ã¾ãš<strong>Notionã¨ã„ã†ã€Œç¬¬äºŒã®è„³ã€ã§é–¢é€£æƒ…å ±ã‚’æ¤œç´¢</strong>ã—ã€è¦‹ã¤ã‘ãŸæƒ…å ±ã‚’AIã«<strong>ã€Œå‚è€ƒè³‡æ–™ã€ã¨ã—ã¦æ¸¡ã—ã¦ã‹ã‚‰å›ç­”ã‚’ç”Ÿæˆ</strong>ã•ã›ã‚‹ã€ã¨ã„ã†æµã‚Œã«ãªã‚Šã¾ã™ã€‚</p>
    <p>ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€<code>app.py</code>ã«Notionã‚’æ¤œç´¢ã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã€AIã¸ã®æŒ‡ç¤ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’å·¥å¤«ã—ã¾ã™ã€‚</p>
    <hr>

    <h2>æ”¹é€ ç‰ˆ <code>app.py</code> ã®å…¨ã‚³ãƒ¼ãƒ‰</h2>
    <p>ç¾åœ¨ã®<code>app.py</code>ã‚’ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ã¾ã‚‹ã”ã¨å·®ã—æ›¿ãˆã¦ãã ã•ã„ã€‚å¤‰æ›´ç‚¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã€ã‚³ãƒ¼ãƒ‰ä¸‹ã®è§£èª¬ã§èª¬æ˜ã—ã¾ã™ã€‚</p>

<pre><code class="language-python">
import os
import openai
import requests
import json
import streamlit as st
from openai import OpenAI

# --- è¨­å®šã¨Secrets ---
st.set_page_config(page_title="My AIãƒãƒ£ãƒƒãƒˆ")
st.title("ğŸ§  Notioné€£æºAIãƒãƒ£ãƒƒãƒˆ")

# --- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ– ---
try:
    client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])
    notion_api_key = st.secrets["NOTION_API_KEY"]
    notion_database_id = st.secrets["NOTION_DATABASE_ID"]
except FileNotFoundError:
    client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
    notion_api_key = os.getenv("NOTION_API_KEY Tabase_id"))

# --- Notioné€£æºé–¢æ•° ---

# ã€æ–°æ©Ÿèƒ½ã€‘Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ¤œç´¢ã™ã‚‹é–¢æ•°
def search_notion_database(query_text):
    """
    æŒ‡å®šã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã§Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®"Prompt"åˆ—ã‚’æ¤œç´¢ã—ã€
    é–¢é€£ã™ã‚‹éå»ã®ã‚„ã‚Šå–ã‚Šã‚’æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã™ã€‚
    """
    url = f"https://api.notion.com/v1/databases/{notion_database_id}/query"
    headers = {
        "Authorization": f"Bearer {notion_api_key}",
        "Content-Type": "application/json",
        "Notion-Version": "2022-06-28",
    }
    query_data = {
        "filter": {
            "property": "Prompt",
            "title": {
                "contains": query_text
            }
        },
        "sorts": [
            {
                "property": "Timestamp",
                "direction": "descending"
            }
        ]
    }

    past_conversations = ""
    try:
        res = requests.post(url, headers=headers, data=json.dumps(query_data))
        res.raise_for_status()
        results = res.json()["results"]
        
        for page in results[:3]:
            prompt = page["properties"]["Prompt"]["title"][0]["text"]["content"]
            response = page["properties"]["Response"]["rich_text"][0]["text"]["content"]
            past_conversations += f"éå»ã®è³ªå•: {prompt}\\néå»ã®å›ç­”: {response}\\n---\\n"
        
        return past_conversations
    except requests.exceptions.RequestException as e:
        print(f"Notionæ¤œç´¢ã‚¨ãƒ©ãƒ¼: {e}")
        return ""

# Notionã«ä¿å­˜ã™ã‚‹é–¢æ•° (å¤‰æ›´ãªã—)
def save_to_notion(prompt, response):
    url = "https://api.notion.com/v1/pages"
    headers = {
        "Authorization": f"Bearer {notion_api_key}",
        "Content-Type": "application/json",
        "Notion-Version": "2022-06-28",
    }
    new_page_data = {
        "parent": {"database_id": notion_database_id},
        "properties": {
            "Prompt": {"title": [{"text": {"content": prompt}}]},
            "Response": {"rich_text": [{"text": {"content": response}}]},
        },
    }
    try:
        res = requests.post(url, headers=headers, data=json.dumps(new_page_data))
        res.raise_for_status()
        return True, "âœ… Notionã¸ã®ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸï¼"
    except requests.exceptions.RequestException as e:
        return False, f"âŒ Notionã¸ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}\\nè©³ç´°: {res.text}"

# --- Streamlitãƒãƒ£ãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯ ---
if "messages" not in st.session_state:
    st.session_state.messages = []

for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

if prompt := st.chat_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.chat_message("assistant"):
        message_placeholder = st.empty()
        
        context_from_notion = search_notion_database(prompt)

        system_prompt = "ã‚ãªãŸã¯å„ªç§€ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚"
        if context_from_notion:
            system_prompt += (
                "\\n\\nãŸã ã—ã€ä»¥ä¸‹ã®éå»ã®ã‚„ã‚Šå–ã‚Šã‚’æœ€é‡è¦ã®å‚è€ƒæƒ…å ±ã¨ã—ã¦æ´»ç”¨ã—ã€"
                "æ–‡è„ˆã‚’è¸ã¾ãˆãŸä¸Šã§å›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\\n"
                f"--- å‚è€ƒæƒ…å ± ---\\n{context_from_notion}"
            )

        completion = client.chat.completions.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": prompt}
            ],
        )
        ai_response = completion.choices[0].message.content
        
        message_placeholder.markdown(ai_response)

    st.session_state.messages.append({"role": "assistant", "content": ai_response})
    
    success, message = save_to_notion(prompt, ai_response)
    if success:
        st.success(message)
    else:
        st.error(message)
</code></pre>

    <hr>
    <h2>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°</h2>
    <div class="note">
        <strong>ã€é‡è¦ã€‘</strong> æ–°ã—ã„æ¤œç´¢æ©Ÿèƒ½ã¯ã€Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®<code>Timestamp</code>åˆ—ã‚’ä½¿ã£ã¦çµæœã‚’ä¸¦ã³æ›¿ãˆã¾ã™ã€‚ã‚‚ã—<code>Timestamp</code>åˆ—ãŒãªã‘ã‚Œã°ã€ä»¥ä¸‹ã®æ‰‹é †ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
    </div>
    <ol>
        <li>Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ãã¾ã™ã€‚</li>
        <li>ãƒ†ãƒ¼ãƒ–ãƒ«ã®å³ç«¯ã«ã‚ã‚‹ã€Œ+ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
        <li>ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ç¨®é¡ã§ã€Œ<strong>ä½œæˆæ—¥æ™‚</strong>ã€ã‚’é¸æŠã—ã€åå‰ã‚’<code>Timestamp</code>ã«ã—ã¾ã™ã€‚</li>
    </ol>

    <hr>
    <h2>ä¸»ãªå¤‰æ›´ç‚¹ã®è§£èª¬</h2>

    <h3>1. <code>search_notion_database</code>é–¢æ•°ã‚’è¿½åŠ ã—ã¾ã—ãŸ</h3>
    <ul>
        <li>ã“ã‚ŒãŒä»Šå›ã®æ©Ÿèƒ½ã®å¿ƒè‡“éƒ¨ã§ã™ã€‚</li>
        <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›æ–‡å­—ã‚’ä½¿ã£ã¦Notion APIã«ã€Œ<code>Prompt</code>åˆ—ã«ã“ã®æ–‡å­—ãŒå«ã¾ã‚Œã‚‹ãƒšãƒ¼ã‚¸ã‚’æ¢ã—ã¦ãã ã•ã„ã€ã¨ã„ã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™ã€‚</li>
        <li>è¦‹ã¤ã‹ã£ãŸéå»ã®ã‚„ã‚Šå–ã‚Šã‚’æ•´å½¢ã—ã¦AIã«è¿”ã—ã¾ã™ã€‚</li>
    </ul>

    <h3>2. AIã¸ã®æŒ‡ç¤ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ</h3>
    <ul>
        <li>ä»¥å‰ã¯å˜ç´”ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’AIã«æŠ•ã’ã‚‹ã ã‘ã§ã—ãŸã€‚</li>
        <li>ä»Šå›ã¯ã€Œã‚ãªãŸã¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€ã¨ã„ã†åŸºæœ¬æŒ‡ç¤ºã«åŠ ãˆã¦ã€Notionæ¤œç´¢çµæœã‚’<strong>å‚è€ƒæƒ…å ±ã¨ã—ã¦æ´»ç”¨ã—ã¦ãã ã•ã„</strong>ã¨ã„ã†æŒ‡ç¤ºã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚</li>
        <li>AIã¯éå»ã®æ–‡è„ˆã‚’è¸ã¾ãˆã¦å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</li>
    </ul>

    <hr>
    <h2>ä½¿ã„æ–¹ã¨å®Ÿè¡Œä¾‹</h2>
    <ol>
        <li>
            ã¾ãšã€ä½•ã‹æƒ…å ±ã‚’è¨˜æ†¶ã•ã›ã¾ã™ã€‚
            <ul>
                <li><strong>ã‚ãªãŸ:</strong> ã€Œåƒ•ã®å¥½ããªãƒ•ãƒ«ãƒ¼ãƒ„ã¯ãƒªãƒ³ã‚´ã§ã™ã€</li>
                <li><strong>AI:</strong> ã€Œæ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚å¥½ããªãƒ•ãƒ«ãƒ¼ãƒ„ãŒãƒªãƒ³ã‚´ã§ã‚ã‚‹ã“ã¨ã‚’è¦šãˆã¦ãŠãã¾ã™ã€‚ã€</li>
                <li>(ã“ã®ã‚„ã‚Šå–ã‚ŠãŒNotionã«ä¿å­˜ã•ã‚Œã‚‹)</li>
            </ul>
        </li>
        <li>
            æ¬¡ã«ã€è¨˜æ†¶ã—ãŸæƒ…å ±ã‚’å°‹ã­ã¾ã™ã€‚
            <ul>
                <li><strong>ã‚ãªãŸ:</strong> ã€Œåƒ•ãŒå¥½ããªãƒ•ãƒ«ãƒ¼ãƒ„ã¯ä½•ã ã£ã‘ï¼Ÿã€</li>
                <li><strong>AI:</strong> ã€Œä»¥å‰ã®ä¼šè©±ã«ã‚ˆã‚Šã¾ã™ã¨ã€ã‚ãªãŸã®å¥½ããªãƒ•ãƒ«ãƒ¼ãƒ„ã¯<strong>ãƒªãƒ³ã‚´</strong>ã§ã™ã€‚ã€</li>
            </ul>
        </li>
    </ol>

    <p>ã“ã®ã‚ˆã†ã«ã€ã‚¢ãƒ—ãƒªãŒã‚ãªãŸã®éå»ã®ç™ºè¨€ã‚’è¦šãˆã¦ã€ãã‚Œã«åŸºã¥ã„ã¦å›ç­”ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
</body>
</html>
