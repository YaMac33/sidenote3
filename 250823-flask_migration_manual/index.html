<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>25.8.23 Streamlit → Flask 移行マニュアル（Googleスプレッドシート連携版）</title>
<style>
body { font-family: sans-serif; line-height: 1.7; margin: 0; padding: 20px; background: #f9f9f9; }
h1, h2, h3 { color: #333; }
section { margin-bottom: 40px; }
pre { background: #272822; color: #f8f8f2; padding: 15px; overflow-x: auto; border-radius: 6px; position: relative; }
code { font-family: monospace; }
.copy-btn {
  position: absolute; top: 8px; right: 8px; 
  background: #0b93f6; color: #fff; border: none;
  padding: 6px 10px; font-size: 12px; border-radius: 4px; cursor: pointer;
}
table { border-collapse: collapse; margin: 20px 0; }
th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
th { background: #eee; }
</style>
<script>
function copyCode(btn){
  const codeBlock = btn.nextElementSibling.innerText;
  navigator.clipboard.writeText(codeBlock).then(()=>{
    btn.innerText = "コピーしました!";
    setTimeout(()=>btn.innerText = "コピー", 1500);
  });
}
</script>
</head>
<body>

<h1>Streamlit → Flask 移行マニュアル（Googleスプレッドシート保存版）</h1>

<section>
<h2>なぜFlaskに作り替えるのか？</h2>
<p><strong>Flaskに移行するとレスポンス速度が大幅に向上する可能性があります。</strong></p>
<p>Streamlitは簡単にUIを作れる反面、ユーザー操作ごとに全スクリプトを再実行するため、AIチャットのような頻繁な処理で速度低下しがちです。</p>
<p>一方、Flaskは必要な処理だけを呼び出す「ルートベース」の仕組みなので無駄が少なく、高速です。</p>

<ul>
<li><strong>Streamlit（🏃‍♂️万能選手）</strong>：毎回全体を再実行 → 無駄が多い</li>
<li><strong>Flask（👩‍💼受付係）</strong>：必要な関数だけ実行 → 高速で効率的</li>
</ul>
</section>

<section>
<h2>メリット・デメリット</h2>
<h3>メリット</h3>
<ul>
<li>高いパフォーマンス（必要な処理のみ実行）</li>
<li>UIをHTML/CSS/JSで完全自由設計</li>
<li>拡張性・スケーラビリティが高い</li>
<li>状態管理が明確で効率的</li>
</ul>

<h3>デメリット</h3>
<ul>
<li>開発スピードが落ちる（コード量増加）</li>
<li>Webフレームワークの学習が必要</li>
</ul>

<h3>比較表</h3>
<table>
<tr><th>項目</th><th>Flask</th><th>Streamlit</th></tr>
<tr><td>レスポンス速度</td><td>速い</td><td>遅い傾向</td></tr>
<tr><td>開発スピード</td><td>やや遅い</td><td>非常に速い</td></tr>
<tr><td>UI自由度</td><td>非常に高い</td><td>制限あり</td></tr>
<tr><td>拡張性</td><td>高い</td><td>低い</td></tr>
<tr><td>学習コスト</td><td>やや高い</td><td>非常に低い</td></tr>
</table>
</section>

<section>
<h2>Flaskプロジェクト構成</h2>
<pre><button class="copy-btn" onclick="copyCode(this)">コピー</button><code>
/flask_chat_app
├── .env
├── app.py
├── requirements.txt
├── /static
│   └── style.css
└── /templates
    └── index.html
</code></pre>
</section>

<section>
<h2>1. 必要なライブラリ</h2>
<pre><button class="copy-btn" onclick="copyCode(this)">コピー</button><code>
flask
openai
requests
python-dotenv
gspread
google-auth-oauthlib
</code></pre>
</section>

<section>
<h2>2. .envファイル</h2>
<pre><button class="copy-btn" onclick="copyCode(this)">コピー</button><code>
OPENAI_API_KEY="sk-..."
GOOGLE_SHEET_ID="YOUR_SPREADSHEET_ID_HERE"
</code></pre>
</section>

<section>
<h2>3. CSS（static/style.css）</h2>
<pre><button class="copy-btn" onclick="copyCode(this)">コピー</button><code>
body {
  background-color: #f0f0f0;
  font-family: sans-serif;
  margin: 0;
}
.chat-container {
  max-width: 750px; margin: auto; background-color: white;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  display: flex; flex-direction: column; height: 100vh;
}
header { text-align: center; padding: 20px; border-bottom: 1px solid #ddd; }
.chat-box { flex-grow: 1; padding: 20px; overflow-y: auto; }
.user-bubble, .assistant-bubble {
  padding: 10px 14px; border-radius: 18px; margin: 5px 0;
  max-width: 75%; word-wrap: break-word;
}
.user-bubble { background-color: #0b93f6; color: white; margin-left: auto; }
.assistant-bubble { background-color: #e5e5ea; color: black; margin-right: auto; }
.input-area { display: flex; padding: 10px; border-top: 1px solid #ddd; }
.input-area input {
  flex-grow: 1; border-radius: 18px; padding: 10px 14px;
  border: 1px solid #ccc; margin-right: 10px;
}
.input-area button {
  border-radius: 18px; border: none; background-color: #0b93f6;
  color: white; padding: 10px 20px; cursor: pointer;
}
</code></pre>
</section>

<section>
<h2>4. HTML（templates/index.html）</h2>
<pre><button class="copy-btn" onclick="copyCode(this)">コピー</button><code>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatGPT with Flask</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="chat-container">
<header><h2>ChatGPT</h2></header>
<div class="chat-box" id="chat-box">
{% for message in messages %}
  {% if message.role == 'user' %}
    <div class="user-bubble">{{ message.content }}</div>
  {% else %}
    <div class="assistant-bubble">{{ message.content }}</div>
  {% endif %}
{% endfor %}
</div>
<div class="input-area">
<form method="POST" style="display: flex; width: 100%;">
<input type="text" name="prompt" placeholder="メッセージを入力" required autocomplete="off">
<button type="submit">送信</button>
</form>
</div>
</div>
<script>
const chatBox = document.getElementById('chat-box');
chatBox.scrollTop = chatBox.scrollHeight;
</script>
</body>
</html>
</code></pre>
</section>

<section>
<h2>5. Flaskロジック（app.py）</h2>
<pre><button class="copy-btn" onclick="copyCode(this)">コピー</button><code>
import os, openai
from flask import Flask, render_template, request, session
from openai import OpenAI
from dotenv import load_dotenv
import gspread

load_dotenv()
app = Flask(__name__)
app.config['SECRET_KEY'] = 'your-very-secret-key'

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
google_sheet_id = os.getenv("GOOGLE_SHEET_ID")

def save_to_google_sheet(prompt, response):
    try:
        gc = gspread.service_account(filename='service_account.json')
        sh = gc.open_by_key(google_sheet_id)
        ws = sh.sheet1
        ws.append_row([prompt, response])
        print("Googleスプレッドシートに保存しました。")
    except Exception as e:
        print("保存エラー:", e)

@app.route('/', methods=['GET','POST'])
def chat():
    if 'messages' not in session:
        session['messages'] = []
    if request.method == 'POST':
        prompt = request.form['prompt']
        session['messages'].append({"role":"user","content":prompt})
        completion = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=session['messages']
        )
        ai_response = completion.choices[0].message.content
        session['messages'].append({"role":"assistant","content":ai_response})
        save_to_google_sheet(prompt, ai_response)
        session.modified = True
    return render_template('index.html', messages=session['messages'])

if __name__ == '__main__':
    app.run(debug=True)
</code></pre>
</section>

<section>
<h2>6. 実行方法</h2>
<ol>
<li>ターミナルで <code>pip install -r requirements.txt</code></li>
<li><code>flask run</code> を実行</li>
<li>ブラウザで <code>http://127.0.0.1:5000</code> を開く</li>
<li>チャット送信 → Googleスプレッドシートに保存されます</li>
</ol>
</section>

</body>
</html>
