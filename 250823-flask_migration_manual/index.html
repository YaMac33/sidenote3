<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StreamlitアプリをFlaskに移行するマニュアル</title>
<style>
body {
  font-family: "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  line-height: 1.7;
  background: #f9f9f9;
  color: #333;
  margin: 0;
  padding: 0;
}
header {
  background: #005bac;
  color: white;
  text-align: center;
  padding: 1.5em 1em;
}
main {
  max-width: 1000px;
  margin: auto;
  background: white;
  padding: 2em;
}
h1, h2, h3 {
  color: #005bac;
}
pre {
  background: #f0f0f0;
  padding: 1em;
  overflow-x: auto;
  border-radius: 6px;
  font-size: 0.9em;
}
code {
  font-family: monospace;
}
ul, ol {
  margin: 0 0 1.2em 1.5em;
}
table {
  border-collapse: collapse;
  width: 100%;
  margin: 1em 0;
}
th, td {
  border: 1px solid #ccc;
  padding: 0.6em;
  text-align: center;
}
th {
  background: #f0f0f0;
}
.highlight {
  background: #fff8dc;
  padding: 0.8em;
  border-left: 5px solid #ff9800;
  margin: 1.5em 0;
}
</style>
</head>
<body>
<header>
  <h1>StreamlitアプリをFlaskに移行するマニュアル</h1>
</header>
<main>
  <h2>1. Flaskに移行する理由</h2>
  <p>
    StreamlitでAIチャットアプリを作成すると、ユーザー操作ごとにスクリプト全体が再実行されます。
    Flaskに移行すると<strong>不要な再実行がなくなり、レスポンス速度が大幅に改善</strong>します。
  </p>

  <h3>実行モデルの違い</h3>
  <ul>
    <li><strong>Streamlit 🏃‍♂️（真面目な万能選手）</strong><br>
      毎回スクリプト全体を再実行。モデル再読み込みなど無駄が多い。</li>
    <li><strong>Flask 👩‍💼（専門の受付係）</strong><br>
      必要な処理だけ実行。UI再描画や余計な処理をせず高速応答。</li>
  </ul>

  <h3>メリット・デメリット</h3>
  <h4>メリット</h4>
  <ul>
    <li>高いパフォーマンス（不要な処理を省略）</li>
    <li>UIをHTML/CSS/JSで完全自由に設計可能</li>
    <li>高い拡張性・スケーラビリティ</li>
    <li>サーバー側での明確な状態管理</li>
  </ul>
  <h4>デメリット</h4>
  <ul>
    <li>開発速度が低下（コード量増加）</li>
    <li>Webフレームワークの学習コスト</li>
  </ul>

  <table>
    <thead>
      <tr>
        <th>項目</th><th>Flask</th><th>Streamlit</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>レスポンス速度</td><td>速い</td><td>遅くなる傾向</td></tr>
      <tr><td>開発スピード</td><td>時間がかかる</td><td>非常に速い</td></tr>
      <tr><td>UI自由度</td><td>非常に高い</td><td>制限あり</td></tr>
      <tr><td>拡張性</td><td>高い（本番向け）</td><td>低い（試作向け）</td></tr>
      <tr><td>学習コスト</td><td>やや高い</td><td>非常に低い</td></tr>
    </tbody>
  </table>

  <div class="highlight">
    <strong>結論：</strong>
    プロトタイプはStreamlit、本番運用や高速化・独自UIはFlaskが適切な選択です。
  </div>

  <h2>2. Flaskアプリの作り方</h2>

  <h3>2.1 プロジェクト構成</h3>
  <pre><code>/flask_chat_app
├── .env
├── app.py
├── requirements.txt
├── /static
│   └── style.css
└── /templates
    └── index.html
</code></pre>

  <h3>2.2 必要なライブラリ</h3>
  <pre><code>flask
openai
requests
python-dotenv
</code></pre>
  <p>ターミナルで以下を実行:</p>
  <pre><code>pip install -r requirements.txt</code></pre>

  <h3>2.3 環境変数設定</h3>
  <pre><code>.env
OPENAI_API_KEY="sk-..."
NOTION_API_KEY="secret_..."
NOTION_DATABASE_ID="..."
</code></pre>

  <h3>2.4 CSS (static/style.css)</h3>
  <pre><code>body {
  background-color: #f0f0f0;
  font-family: sans-serif;
  margin: 0;
}
.chat-container {
  max-width: 750px;
  margin: auto;
  background-color: white;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  height: 100vh;
}
header { text-align: center; padding: 20px; border-bottom: 1px solid #ddd; }
.chat-box { flex-grow: 1; padding: 20px; overflow-y: auto; }
.user-bubble, .assistant-bubble {
  padding: 10px 14px; border-radius: 18px; margin: 5px 0;
  max-width: 75%; word-wrap: break-word;
}
.user-bubble { background-color: #0b93f6; color: white; margin-left: auto; }
.assistant-bubble { background-color: #e5e5ea; color: black; margin-right: auto; }
.input-area { display: flex; padding: 10px; border-top: 1px solid #ddd; }
.input-area input {
  flex-grow: 1; border-radius: 18px; padding: 10px 14px;
  border: 1px solid #ccc; margin-right: 10px;
}
.input-area button {
  border-radius: 18px; border: none; background-color: #0b93f6;
  color: white; padding: 10px 20px; cursor: pointer;
}
</code></pre>

  <h3>2.5 HTML (templates/index.html)</h3>
  <pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
  &lt;title&gt;ChatGPT with Flask&lt;/title&gt;
  &lt;link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class="chat-container"&gt;
    &lt;header&gt;&lt;h2&gt;ChatGPT&lt;/h2&gt;&lt;/header&gt;
    &lt;div class="chat-box" id="chat-box"&gt;
      {% for message in messages %}
        {% if message.role == 'user' %}
          &lt;div class="user-bubble"&gt;{{ message.content }}&lt;/div&gt;
        {% else %}
          &lt;div class="assistant-bubble"&gt;{{ message.content }}&lt;/div&gt;
        {% endif %}
      {% endfor %}
    &lt;/div&gt;
    &lt;div class="input-area"&gt;
      &lt;form method="POST" style="display:flex;width:100%;"&gt;
        &lt;input type="text" name="prompt" placeholder="メッセージを入力してください" required autocomplete="off"&gt;
        &lt;button type="submit"&gt;送信&lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;script&gt;
    const chatBox = document.getElementById('chat-box');
    chatBox.scrollTop = chatBox.scrollHeight;
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

  <h3>2.6 Flaskメインコード (app.py)</h3>
  <pre><code>import os, json, requests
from flask import Flask, render_template, request, session
from openai import OpenAI
from dotenv import load_dotenv

load_dotenv()
app = Flask(__name__)
app.config['SECRET_KEY'] = 'your-very-secret-key'

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
notion_api_key = os.getenv("NOTION_API_KEY")
notion_database_id = os.getenv("NOTION_DATABASE_ID")

def save_to_notion(prompt, response):
    url = "https://api.notion.com/v1/pages"
    headers = {
        "Authorization": f"Bearer {notion_api_key}",
        "Content-Type": "application/json",
        "Notion-Version": "2022-06-28",
    }
    data = {
        "parent": {"database_id": notion_database_id},
        "properties": {
            "Prompt": {"title": [{"text": {"content": prompt}}]},
            "Response": {"rich_text": [{"text": {"content": response}}]},
        },
    }
    try:
        res = requests.post(url, headers=headers, data=json.dumps(data))
        res.raise_for_status()
        print("Notionに保存しました。")
    except requests.exceptions.RequestException as e:
        print(f"Notion保存エラー: {e}")

@app.route('/', methods=['GET', 'POST'])
def chat():
    if 'messages' not in session:
        session['messages'] = []
    if request.method == 'POST':
        prompt = request.form['prompt']
        session['messages'].append({"role": "user", "content": prompt})
        completion = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=session['messages']
        )
        ai_response = completion.choices[0].message.content
        session['messages'].append({"role": "assistant", "content": ai_response})
        save_to_notion(prompt, ai_response)
        session.modified = True
    return render_template('index.html', messages=session['messages'])

if __name__ == '__main__':
    app.run(debug=True)
</code></pre>

  <h3>2.7 アプリの実行</h3>
  <ol>
    <li>ターミナルでプロジェクトフォルダに移動</li>
    <li><code>pip install -r requirements.txt</code> を実行（初回のみ）</li>
    <li><code>flask run</code> を実行</li>
    <li>ブラウザで <code>http://127.0.0.1:5000</code> にアクセス</li>
  </ol>

  <div class="highlight">
    これでStreamlitアプリと同等機能を持つFlaskチャットアプリが完成です！
  </div>
</main>
</body>
</html>
